<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eric Projects - Graffiti Map</title>
    <!-- OpenLayers -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v9.2.4/ol.css">
    <script src="https://cdn.jsdelivr.net/npm/ol@v9.2.4/dist/ol.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }
        #map {
            width: 100%;
            height: 100%;
            background-color: #1a202c; /* Dark background while map loads */
        }
        .ol-popup {
            position: absolute;
            background-color: rgba(30, 41, 59, 0.9); /* bg-slate-800 with transparency */
            backdrop-filter: blur(8px);
            color: white;
            box-shadow: 0 4px 30px rgba(0,0,0,0.5);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #334155; /* border-slate-700 */
            bottom: 12px;
            left: -50px;
            min-width: 280px;
            max-width: 320px; /* Adjusted max-width */
            transform: translateX(-50%);
            transition: all 0.3s ease;
            pointer-events: none; /* Make hover popup non-interactive */
        }
        .ol-popup:after, .ol-popup:before {
            top: 100%; border: solid transparent; content: " "; height: 0; width: 0; position: absolute; pointer-events: none; left: 50%;
        }
        .ol-popup:after { border-top-color: rgba(30, 41, 59, 0.9); border-width: 10px; margin-left: -10px; }
        .ol-popup:before { border-top-color: #334155; border-width: 11px; margin-left: -11px; }
        
        #popup-content img, #media-viewer-content img { max-width: 100%; border-radius: 8px; margin-top: 10px; border: 1px solid #334155; }
        #popup-content iframe, #media-viewer-content iframe {
            width: 100%;
            aspect-ratio: 16 / 9;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid #334155;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        .modal-fade-in { animation: fadeIn 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        .map-cursor-add { cursor: crosshair; }
        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); }
        }
        .pulse-animation { animation: pulse 2s infinite; }
    </style>
</head>
<body class="bg-slate-900">

    <!-- Authentication Screen -->
    <div id="auth-container" class="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center p-4">
        <div class="w-full max-w-sm p-8 bg-slate-800 rounded-2xl shadow-2xl border border-slate-700">
            <!-- Login Form -->
            <div id="login-form-container">
                <h2 class="text-3xl font-black text-center text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-500 mb-2">Eric Projects</h2>
                <p class="text-center text-slate-400 mb-6">Log in to make your mark on the world.</p>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="login-username" class="block text-sm font-medium text-slate-300">Username</label>
                        <input type="text" id="login-username" required class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-white transition">
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-sm font-medium text-slate-300">Password</label>
                        <input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-white transition">
                    </div>
                    <button type="submit" class="w-full py-2.5 px-4 bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-semibold rounded-md hover:from-indigo-600 hover:to-purple-700 transition transform hover:scale-105 shadow-lg">Login</button>
                    <p id="login-error" class="text-red-400 text-sm mt-3 text-center h-4"></p>
                </form>
                <p class="mt-4 text-center text-sm text-slate-400">Don't have an account? <a href="#" id="show-register" class="font-medium text-indigo-400 hover:text-indigo-300">Sign Up</a></p>
                <p class="text-center text-xs text-slate-500 mt-8">by ERIC Team</p>
            </div>
            <!-- Registration Form -->
            <div id="register-form-container" class="hidden">
                <h2 class="text-3xl font-bold text-center text-white mb-6">Create Account</h2>
                <form id="register-form">
                    <div class="mb-4">
                        <label for="register-username" class="block text-sm font-medium text-slate-300">Username</label>
                        <input type="text" id="register-username" required class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-white transition">
                    </div>
                    <div class="mb-6">
                        <label for="register-password" class="block text-sm font-medium text-slate-300">Password</label>
                        <input type="password" id="register-password" required class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-white transition">
                    </div>
                    <button type="submit" class="w-full py-2.5 px-4 bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-semibold rounded-md hover:from-indigo-600 hover:to-purple-700 transition transform hover:scale-105 shadow-lg">Register</button>
                    <p id="register-error" class="text-red-400 text-sm mt-3 text-center h-4"></p>
                </form>
                <p class="mt-4 text-center text-sm text-slate-400">Already have an account? <a href="#" id="show-login" class="font-medium text-indigo-400 hover:text-indigo-300">Log In</a></p>
            </div>
        </div>
    </div>

    <!-- Map Container (Fullscreen) -->
    <div id="map-app-container" class="h-screen w-screen hidden relative">
        <div id="map"></div>

        <!-- Header over the map -->
        <header class="absolute top-0 left-0 right-0 p-4 z-20 flex justify-between items-center gap-4 bg-gradient-to-b from-black/60 to-transparent">
            <h1 class="hidden sm:block text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-500">Eric Projects</h1>
            <div class="flex-1 flex items-center justify-center sm:justify-start gap-2 md:gap-4">
                <a href="#" target="_blank" rel="noopener noreferrer" class="px-3 py-2 text-sm font-semibold bg-white/10 text-white rounded-lg backdrop-blur-sm hover:bg-white/20 transition flex items-center gap-2"><i data-lucide="line-chart"></i><span class="hidden md:inline">Pumpfun</span></a>
                <a href="https://youtube.com/@ericemprende-finanzas?si=hL_aJy3R916mPFZD" target="_blank" rel="noopener noreferrer" class="px-3 py-2 text-sm font-semibold bg-white/10 text-white rounded-lg backdrop-blur-sm hover:bg-white/20 transition flex items-center gap-2"><i data-lucide="youtube"></i><span class="hidden md:inline">YouTube</span></a>
                <a href="https://x.com/ericemprende" target="_blank" rel="noopener noreferrer" class="px-3 py-2 text-sm font-semibold bg-white/10 text-white rounded-lg backdrop-blur-sm hover:bg-white/20 transition flex items-center gap-2"><i data-lucide="twitter"></i><span class="hidden md:inline">X</span></a>
            </div>
            <div id="user-info" class="flex items-center gap-4">
                 <button id="challenges-btn" class="px-3 py-2 text-sm font-semibold bg-white/10 text-white rounded-lg backdrop-blur-sm hover:bg-white/20 transition flex items-center gap-2"><i data-lucide="trophy"></i> <span class="hidden md:inline">Challenges</span></button>
                <button id="my-graffiti-btn" class="px-3 py-2 text-sm font-semibold bg-white/10 text-white rounded-lg backdrop-blur-sm hover:bg-white/20 transition flex items-center gap-2"><i data-lucide="history"></i> <span class="hidden md:inline">My Graffiti</span></button>
                <div class="text-right">
                    <p class="font-semibold text-white" id="username-display"></p>
                    <button id="logout-btn" class="text-xs text-indigo-400 hover:underline">Log Out</button>
                </div>
            </div>
        </header>

        <button id="create-graffiti-btn" class="absolute bottom-5 right-5 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-full p-4 shadow-lg hover:from-indigo-600 hover:to-purple-700 focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-offset-slate-900 focus:ring-indigo-500 z-10 pulse-animation">
            <i data-lucide="pen-square"></i>
        </button>
    </div>
    
    <!-- OpenLayers Popup (for hover) -->
    <div id="popup" class="ol-popup"><div id="popup-content"></div></div>
    
    <!-- Add Graffiti Modal -->
    <div id="graffiti-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-md modal-fade-in border border-slate-700">
            <h2 class="text-2xl font-bold mb-4 text-white">Add Graffiti</h2>
            <form id="graffiti-form">
                <input type="hidden" id="latitude" name="latitude"><input type="hidden" id="longitude" name="longitude">
                <div class="mb-4">
                    <label for="address" class="block text-sm font-medium text-slate-300">Or search for an address</label>
                    <div class="flex"><input type="text" id="address" class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white sm:text-sm"><button type="button" id="search-address" class="ml-2 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Search</button></div>
                </div>
                <div class="mb-4"><label for="description" class="block text-sm font-medium text-slate-300">Description</label><textarea id="description" rows="3" class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white sm:text-sm" required></textarea></div>
                <div class="mb-4"><label for="color" class="block text-sm font-medium text-slate-300">Marker Color</label><input type="color" id="color" value="#8b5cf6" class="mt-1 block w-full h-10 border-slate-600 rounded-md bg-slate-700"></div>
                
                <div class="mb-4 space-y-4">
                    <div>
                        <label for="image-url" class="block text-sm font-medium text-slate-300">Image URL</label>
                        <input type="url" id="image-url" placeholder="https://example.com/image.jpg" class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-white">
                    </div>
                     <div>
                        <label for="video-url" class="block text-sm font-medium text-slate-300">YouTube Video URL</label>
                        <input type="url" id="video-url" placeholder="https://www.youtube.com/watch?v=..." class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-white">
                    </div>
                </div>

                <div class="flex justify-end space-x-2"><button type="button" id="cancel-graffiti" class="px-4 py-2 bg-slate-600 text-white rounded-md hover:bg-slate-500 transition">Cancel</button><button type="submit" id="submit-graffiti" class="px-4 py-2 bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-semibold rounded-md hover:from-indigo-600 hover:to-purple-700 transition">Save</button></div>
            </form>
        </div>
    </div>
    
    <!-- "My Graffiti" Modal -->
    <div id="my-graffiti-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-lg modal-fade-in border border-slate-700 flex flex-col" style="height: 70vh;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white flex items-center gap-2"><i data-lucide="history"></i> My History</h2>
                <button id="close-my-graffiti-modal" class="text-slate-400 hover:text-white transition"><i data-lucide="x"></i></button>
            </div>
            <div id="my-graffiti-list" class="flex-grow overflow-y-auto pr-2"></div>
        </div>
    </div>

    <!-- Challenges Modal -->
    <div id="challenges-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-lg modal-fade-in border border-slate-700 flex flex-col" style="height: 70vh;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white flex items-center gap-2"><i data-lucide="trophy"></i> Active Challenges</h2>
                <button id="close-challenges-modal" class="text-slate-400 hover:text-white transition"><i data-lucide="x"></i></button>
            </div>
            <div id="challenges-list" class="flex-grow overflow-y-auto pr-2 space-y-3">
                 <div class="p-4 bg-slate-700 rounded-lg"><h3 class="font-bold text-indigo-400">First Mark</h3><p class="text-sm text-slate-300 mt-1">Place your first graffiti anywhere on the map.</p></div>
                 <div class="p-4 bg-slate-700 rounded-lg"><h3 class="font-bold text-indigo-400">Urban Explorer</h3><p class="text-sm text-slate-300 mt-1">Place graffiti in 3 different cities.</p></div>
                 <div class="p-4 bg-slate-700 rounded-lg"><h3 class="font-bold text-indigo-400">Video Artist</h3><p class="text-sm text-slate-300 mt-1">Add a graffiti that includes a YouTube video.</p></div>
                 <div class="p-4 bg-slate-700 rounded-lg"><h3 class="font-bold text-indigo-400">Around the World</h3><p class="text-sm text-slate-300 mt-1">Place graffiti on 3 different continents.</p></div>
            </div>
        </div>
    </div>

    <!-- Media Viewer Modal (for click) -->
    <div id="media-viewer-modal" class="fixed inset-0 bg-black bg-opacity-80 backdrop-blur-sm flex items-center justify-center p-4 z-[60] hidden">
        <div class="bg-slate-800 rounded-lg shadow-xl w-full max-w-2xl modal-fade-in border border-slate-700 flex flex-col relative">
             <button id="close-media-viewer" class="absolute -top-3 -right-3 text-slate-400 bg-slate-800 rounded-full p-1.5 border border-slate-700 hover:text-white transition z-10"><i data-lucide="x"></i></button>
             <div id="media-viewer-content" class="w-full"></div>
             <div class="p-6">
                <h3 id="media-viewer-title" class="text-2xl font-bold text-white"></h3>
                <p id="media-viewer-author" class="text-sm text-slate-400 mb-4"></p>
                <p id="media-viewer-description" class="text-slate-300"></p>
                <a id="media-viewer-youtube-link" href="#" target="_blank" class="mt-4 inline-flex items-center gap-2 px-4 py-2 bg-red-600 text-white font-semibold rounded-md hover:bg-red-700 transition hidden">
                    <i data-lucide="youtube"></i> View on YouTube
                </a>
             </div>
        </div>
    </div>


    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, setDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBvk61LjapStYDRvUJY2duNbYZxvK6BCOk",
            authDomain: "carreras-pro.firebaseapp.com",
            projectId: "carreras-pro",
            storageBucket: "carreras-pro.appspot.com",
            messagingSenderId: "691582453913",
            appId: "1:691582453913:web:1e1a607c1aae110f325008",
            measurementId: "G-0LC4YDBWPL"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let userId;
        let map; 
        let isPlacingGraffiti = false;
        
        const authContainer = document.getElementById('auth-container');
        const mapAppContainer = document.getElementById('map-app-container');

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                const userDocRef = doc(db, "users", userId);
                const userDoc = await getDoc(userDocRef);
                const username = userDoc.exists() ? userDoc.data().username : user.email.split('@')[0];
                document.getElementById('username-display').textContent = username;

                authContainer.classList.add('hidden');
                mapAppContainer.classList.remove('hidden');

                if (!map) {
                    setupMap();
                }
                listenToMyGraffiti();
                lucide.createIcons();
            } else {
                authContainer.classList.remove('hidden');
                mapAppContainer.classList.add('hidden');
            }
        });

        document.getElementById('show-register').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('login-form-container').classList.add('hidden'); document.getElementById('register-form-container').classList.remove('hidden'); });
        document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('register-form-container').classList.add('hidden'); document.getElementById('login-form-container').classList.remove('hidden'); });
        
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;
            const errorP = document.getElementById('register-error');
            errorP.textContent = '';
            const email = `${username.trim().toLowerCase()}@graffiti-map.com`;
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(db, "users", userCredential.user.uid), { username: username });
            } catch (error) {
                errorP.textContent = error.code === 'auth/email-already-in-use' ? 'This username already exists.' : (error.code === 'auth/weak-password' ? 'Password must be at least 6 characters.' : 'Registration error.');
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const errorP = document.getElementById('login-error');
            errorP.textContent = '';
            const email = `${username.trim().toLowerCase()}@graffiti-map.com`;
            try { await signInWithEmailAndPassword(auth, email, password); } catch (error) { errorP.textContent = 'Incorrect username or password.'; }
        });

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        const popupContainer = document.getElementById('popup');
        const popupContent = document.getElementById('popup-content');
        const overlay = new ol.Overlay({ element: popupContainer, autoPan: false });
        
        function getYouTubeVideoId(url) {
            let ID = '';
            url = url.replace(/(>|<)/gi, '').split(/(vi\/|v=|\/v\/|youtu\.be\/|\/embed\/)/);
            if (url[2] !== undefined) {
                ID = url[2].split(/[^0-9a-z_\-]/i);
                ID = ID[0];
            } else {
                ID = url;
            }
            return ID;
        }

        function setupMap() {
            const graffitiLayer = new ol.layer.Vector({
                source: new ol.source.Vector(),
                style: (feature) => new ol.style.Style({
                    image: new ol.style.Circle({
                        radius: 8,
                        fill: new ol.style.Fill({ color: feature.get('color') || '#8b5cf6' }),
                        stroke: new ol.style.Stroke({ color: 'rgba(255,255,255,0.8)', width: 2.5 })
                    })
                })
            });

            const tileLayer = new ol.layer.Tile({
                source: new ol.source.XYZ({
                    url: 'https://{a-d}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png',
                    attributions: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                })
            });

            map = new ol.Map({
                target: 'map',
                layers: [tileLayer, graffitiLayer],
                view: new ol.View({ center: ol.proj.fromLonLat([-74.006, 40.7128]), zoom: 3 }),
                overlays: [overlay],
                controls: []
            });

            onSnapshot(query(collection(db, `graffiti`)), (snapshot) => {
                graffitiLayer.getSource().clear();
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const feature = new ol.Feature({
                        geometry: new ol.geom.Point(ol.proj.fromLonLat(data.coordinates)),
                        ...data
                    });
                    graffitiLayer.getSource().addFeature(feature);
                });
            });

            const createBtn = document.getElementById('create-graffiti-btn');
            const mapElement = document.getElementById('map');
            const modal = document.getElementById('graffiti-modal');

            createBtn.addEventListener('click', () => {
                isPlacingGraffiti = true;
                mapElement.classList.add('map-cursor-add');
                createBtn.classList.remove('pulse-animation');
                createBtn.innerHTML = `<span class="text-sm px-2">Click on the map</span>`;
            });

            function resetPlacingMode() {
                isPlacingGraffiti = false;
                mapElement.classList.remove('map-cursor-add');
                createBtn.classList.add('pulse-animation');
                createBtn.innerHTML = `<i data-lucide="pen-square"></i>`;
                lucide.createIcons();
            }

            map.on('click', (evt) => {
                if (isPlacingGraffiti) {
                    const coords = ol.proj.toLonLat(evt.coordinate);
                    document.getElementById('latitude').value = coords[1];
                    document.getElementById('longitude').value = coords[0];
                    modal.classList.remove('hidden');
                    resetPlacingMode();
                }
            });

            let hoveredFeature = null;
            map.on('pointermove', (e) => {
                if (isPlacingGraffiti) {
                     map.getTargetElement().style.cursor = 'crosshair';
                     return;
                }
                const feature = map.forEachFeatureAtPixel(e.pixel, f => f);
                map.getTargetElement().style.cursor = feature ? 'pointer' : '';

                if (feature !== hoveredFeature) {
                    if (hoveredFeature) {
                        overlay.setPosition(undefined);
                    }
                    if (feature) {
                        const coordinates = feature.getGeometry().getCoordinates();
                        const videoUrl = feature.get('videoUrl');
                        const imageUrl = feature.get('imageUrl');
                        let content = `<h4 class="font-bold text-base text-white truncate">${feature.get('description')}</h4>`;
                        
                        if (videoUrl) {
                            const videoId = getYouTubeVideoId(videoUrl);
                            if (videoId) {
                                content += `<iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&controls=0&showinfo=0&loop=1&playlist=${videoId}" frameborder="0" allow="autoplay" class="pointer-events-none"></iframe>`;
                            }
                        } else if (imageUrl) {
                            content += `<img src="${imageUrl}" alt="Graffiti Image">`;
                        }
                        popupContent.innerHTML = content;
                        overlay.setPosition(coordinates);
                    }
                    hoveredFeature = feature;
                }
            });

            const mediaViewerModal = document.getElementById('media-viewer-modal');
            map.on('singleclick', (evt) => {
                if (isPlacingGraffiti) return;
                const feature = map.forEachFeatureAtPixel(evt.pixel, (f) => f);

                if (feature) {
                    overlay.setPosition(undefined); // Hide hover popup
                    hoveredFeature = null;
                    
                    const { description, authorUsername, videoUrl, imageUrl } = feature.getProperties();

                    document.getElementById('media-viewer-title').textContent = description;
                    document.getElementById('media-viewer-author').textContent = authorUsername ? `By: ${authorUsername}` : '';
                    document.getElementById('media-viewer-description').textContent = description; // You can expand on this if you add more fields
                    
                    const mediaContentEl = document.getElementById('media-viewer-content');
                    const youtubeLinkEl = document.getElementById('media-viewer-youtube-link');
                    mediaContentEl.innerHTML = '';
                    youtubeLinkEl.classList.add('hidden');

                    if (videoUrl) {
                        const videoId = getYouTubeVideoId(videoUrl);
                        if (videoId) {
                            mediaContentEl.innerHTML = `<iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
                            youtubeLinkEl.href = videoUrl;
                            youtubeLinkEl.classList.remove('hidden');
                        }
                    } else if (imageUrl) {
                        mediaContentEl.innerHTML = `<img src="${imageUrl}" alt="Graffiti Image">`;
                    }
                    
                    mediaViewerModal.classList.remove('hidden');
                    lucide.createIcons();
                }
            });
        }
        
        const graffitiModal = document.getElementById('graffiti-modal');
        const graffitiForm = document.getElementById('graffiti-form');
        const myGraffitiModal = document.getElementById('my-graffiti-modal');
        const challengesModal = document.getElementById('challenges-modal');
        const mediaViewerModal = document.getElementById('media-viewer-modal');

        document.getElementById('cancel-graffiti').addEventListener('click', () => { graffitiModal.classList.add('hidden'); graffitiForm.reset(); });
        document.getElementById('my-graffiti-btn').addEventListener('click', () => myGraffitiModal.classList.remove('hidden'));
        document.getElementById('close-my-graffiti-modal').addEventListener('click', () => myGraffitiModal.classList.add('hidden'));
        document.getElementById('challenges-btn').addEventListener('click', () => challengesModal.classList.remove('hidden'));
        document.getElementById('close-challenges-modal').addEventListener('click', () => challengesModal.classList.add('hidden'));
        document.getElementById('close-media-viewer').addEventListener('click', () => {
             mediaViewerModal.classList.add('hidden');
             document.getElementById('media-viewer-content').innerHTML = ''; // Stop video
        });

        graffitiForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('submit-graffiti');
            submitBtn.disabled = true; submitBtn.textContent = 'Saving...';

            const imageUrl = document.getElementById('image-url').value || null;
            const videoUrl = document.getElementById('video-url').value || null;
            
            const [description, color, lat, lon] = [
                document.getElementById('description').value, document.getElementById('color').value,
                parseFloat(document.getElementById('latitude').value), parseFloat(document.getElementById('longitude').value)
            ];
            const userDoc = await getDoc(doc(db, "users", userId));
            const authorUsername = userDoc.exists() ? userDoc.data().username : "Anonymous";

            await addDoc(collection(db, `graffiti`), {
                coordinates: [lon, lat], description, color, imageUrl, videoUrl,
                author: userId, authorUsername, createdAt: new Date()
            });
            
            document.getElementById('cancel-graffiti').click();
            submitBtn.disabled = false; submitBtn.textContent = 'Save';
        });

        document.getElementById('search-address').addEventListener('click', async () => {
            const address = document.getElementById('address').value; if(!address) return;
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
            const data = await response.json();
            if(data && data.length > 0) {
                const [lon, lat] = [parseFloat(data[0].lon), parseFloat(data[0].lat)];
                document.getElementById('latitude').value = lat; document.getElementById('longitude').value = lon;
                map.getView().animate({ center: ol.proj.fromLonLat([lon, lat]), zoom: 15, duration: 1000 });
            } else { alert('Address not found.'); }
        });
        
        function listenToMyGraffiti() {
            if (!userId) return;
            const q = query(collection(db, "graffiti"), where("author", "==", userId));
            const graffitiList = document.getElementById('my-graffiti-list');
            
            onSnapshot(q, (snapshot) => {
                graffitiList.innerHTML = '';
                if (snapshot.empty) {
                    graffitiList.innerHTML = `<p class="text-slate-400 text-center mt-4">You haven't created any graffiti yet.</p>`;
                    return;
                }
                snapshot.docs.sort((a,b) => b.data().createdAt.toMillis() - a.data().createdAt.toMillis()).forEach(docSnap => {
                    const graffiti = docSnap.data();
                    const div = document.createElement('div');
                    div.className = 'p-3 bg-slate-700 rounded-lg mb-2 flex justify-between items-center transition hover:bg-slate-600';
                    div.innerHTML = `
                        <p class="text-white truncate pr-4">${graffiti.description}</p>
                        <button class="text-sm bg-indigo-600 px-3 py-1 rounded-md hover:bg-indigo-500 transition flex-shrink-0">View</button>
                    `;
                    div.querySelector('button').addEventListener('click', () => {
                        myGraffitiModal.classList.add('hidden');
                        map.getView().animate({ center: ol.proj.fromLonLat(graffiti.coordinates), zoom: 17, duration: 1000 });
                    });
                    graffitiList.appendChild(div);
                });
            });
        }
    </script>
</body>
</html>

