<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eric Projects - Graffiti Map</title>
    <!-- OpenLayers -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v9.2.4/ol.css">
    <script src="https://cdn.jsdelivr.net/npm/ol@v9.2.4/dist/ol.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Emoji Picker -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }
        #map {
            width: 100%;
            height: 100%;
            background-color: #020617; /* bg-slate-950 */
        }
        .ol-popup {
            position: absolute;
            background-color: rgba(15, 23, 42, 0.9); /* bg-slate-900 with transparency */
            backdrop-filter: blur(8px);
            color: white;
            box-shadow: 0 4px 30px rgba(0,0,0,0.5);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #1e293b; /* border-slate-800 */
            bottom: 12px;
            left: -50px;
            min-width: 280px;
            max-width: 320px;
            transform: translateX(-50%);
            transition: all 0.3s ease;
            pointer-events: none;
        }
        .ol-popup:after, .ol-popup:before {
            top: 100%; border: solid transparent; content: " "; height: 0; width: 0; position: absolute; pointer-events: none; left: 50%;
        }
        .ol-popup:after { border-top-color: rgba(15, 23, 42, 0.9); border-width: 10px; margin-left: -10px; }
        .ol-popup:before { border-top-color: #1e293b; border-width: 11px; margin-left: -11px; }
        
        #popup-content img, #media-viewer-content img { max-width: 100%; border-radius: 8px; margin-top: 10px; border: 1px solid #1e293b; }
        #popup-content iframe, #media-viewer-content iframe {
            width: 100%;
            aspect-ratio: 16 / 9;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid #1e293b;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        .modal-fade-in { animation: fadeIn 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        .map-cursor-add { cursor: crosshair; }
        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(74, 222, 128, 0); }
        }
        .pulse-animation { animation: pulse 2s infinite; }
        .text-glow {
             text-shadow: 0 0 8px rgba(74, 222, 128, 0.5), 0 0 20px rgba(74, 222, 128, 0.3);
        }
        /* Custom scrollbar for chat */
        #chat-messages::-webkit-scrollbar, #my-graffiti-list::-webkit-scrollbar, .challenge-list-container::-webkit-scrollbar { width: 4px; }
        #chat-messages::-webkit-scrollbar-track, #my-graffiti-list::-webkit-scrollbar-track, .challenge-list-container::-webkit-scrollbar-track { background: #1e293b; }
        #chat-messages::-webkit-scrollbar-thumb, #my-graffiti-list::-webkit-scrollbar-thumb, .challenge-list-container::-webkit-scrollbar-thumb { background: #4ade80; border-radius: 4px; }
        
        @keyframes toast-in {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .toast {
            animation: toast-in 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
    </style>
</head>
<body class="bg-slate-950">

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-[100] hidden toast">
        <p id="toast-message"></p>
    </div>

    <!-- Authentication Modal -->
    <div id="auth-container" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="w-full max-w-sm p-8 bg-black/50 backdrop-blur-xl rounded-2xl shadow-2xl border border-slate-800 modal-fade-in relative">
            <button id="close-auth-modal" class="absolute top-4 right-4 text-slate-500 hover:text-white transition"><i data-lucide="x"></i></button>
            <div>
                <h2 class="text-3xl font-black text-center text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-teal-500 mb-2 text-glow">Join the Community</h2>
                <p class="text-center text-slate-400 mb-6">Enter your credentials to continue.</p>
                <form id="auth-form">
                    <div class="mb-4">
                        <label for="auth-username" class="block text-sm font-medium text-slate-300">Username</label>
                        <input type="text" id="auth-username" required class="mt-1 block w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent text-white transition">
                    </div>
                    <div class="mb-4">
                        <label for="auth-password" class="block text-sm font-medium text-slate-300">Password</label>
                        <input type="password" id="auth-password" required class="mt-1 block w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent text-white transition">
                    </div>
                    <div class="mb-6">
                        <label for="auth-wallet" class="block text-sm font-medium text-slate-300">Solana Wallet Address</label>
                        <input type="text" id="auth-wallet" required placeholder="Enter your public Solana wallet address" class="mt-1 block w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent text-white transition">
                    </div>
                    <button type="submit" id="auth-button" class="w-full py-2.5 px-4 bg-gradient-to-r from-green-500 to-teal-600 text-white font-semibold rounded-md hover:from-green-600 hover:to-teal-700 transition transform hover:scale-105 shadow-lg">Continue</button>
                    <p id="auth-error" class="text-red-400 text-sm mt-3 text-center h-4"></p>
                </form>
                <p class="text-center text-xs text-slate-500 mt-8">by ERIC Team</p>
            </div>
        </div>
    </div>

    <!-- Map Container (Fullscreen) -->
    <div id="map-app-container" class="h-screen w-screen relative">
        <div id="map"></div>

        <!-- Header over the map -->
        <header class="absolute top-0 left-0 right-0 p-4 z-20 flex flex-col gap-4 bg-gradient-to-b from-black/80 to-transparent">
            <div class="flex justify-between items-center w-full">
                 <h1 class="hidden sm:block text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-teal-500 text-glow">Eric Projects</h1>
                 <div class="flex-1 flex items-center justify-center sm:justify-start gap-2 md:gap-4 sm:ml-6">
                    <a href="https://youtube.com/@ericemprende-finanzas?si=hL_aJy3R916mPFZD" target="_blank" rel="noopener noreferrer" class="px-3 py-2 text-sm font-semibold bg-white/10 text-white rounded-lg backdrop-blur-sm hover:bg-white/20 transition flex items-center gap-2"><i data-lucide="youtube"></i><span class="hidden md:inline">YouTube</span></a>
                    <a href="https://x.com/ericemprende" class="px-3 py-2 text-sm font-semibold bg-white/10 text-white rounded-lg backdrop-blur-sm hover:bg-white/20 transition flex items-center gap-2"><i data-lucide="twitter"></i><span class="hidden md:inline">X</span></a>
                </div>
                
                 <!-- Logged In User Info -->
                 <div id="user-info" class="hidden items-center gap-4">
                     <div class="text-right">
                        <p class="font-semibold text-white text-lg" id="username-display"></p>
                    </div>
                    <button id="profile-btn" class="text-slate-400 hover:text-white transition-transform hover:scale-110">
                        <img id="user-avatar" src="https://placehold.co/32x32/1e293b/4ade80?text=P" class="w-8 h-8 rounded-full border-2 border-slate-500 object-cover">
                    </button>
                    <button id="logout-btn" class="text-slate-400 hover:text-white transition-transform hover:scale-110"><i data-lucide="log-out"></i></button>
                </div>
                
                <!-- Guest User Login Button -->
                <div id="guest-info" class="">
                    <button id="login-btn" class="px-4 py-2 text-sm font-semibold bg-gradient-to-r from-green-500 to-teal-600 text-white rounded-md hover:from-green-600 hover:to-teal-700 transition transform hover:scale-105 shadow-lg">Login / Register</button>
                </div>
            </div>
        </header>

         <div class="absolute bottom-5 left-5 z-10 flex flex-col gap-3">
             <button id="challenges-btn" class="bg-black/50 backdrop-blur-sm text-white rounded-full p-4 shadow-lg hover:bg-black/70 border border-slate-700 transition-transform hover:scale-110"><i data-lucide="trophy" class="text-yellow-400"></i></button>
             <button data-auth-required="true" id="chat-btn" class="bg-black/50 backdrop-blur-sm text-white rounded-full p-4 shadow-lg hover:bg-black/70 border border-slate-700 transition-transform hover:scale-110"><i data-lucide="message-square"></i></button>
             <button data-auth-required="true" id="my-graffiti-btn" class="bg-black/50 backdrop-blur-sm text-white rounded-full p-4 shadow-lg hover:bg-black/70 border border-slate-700 transition-transform hover:scale-110"><i data-lucide="history"></i></button>
         </div>

        <button data-auth-required="true" id="create-graffiti-btn" class="absolute bottom-5 right-5 bg-gradient-to-r from-green-500 to-teal-600 text-white rounded-full p-4 shadow-lg hover:from-green-600 hover:to-teal-700 focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-offset-slate-950 focus:ring-green-500 z-10 pulse-animation">
            <i data-lucide="pen-square"></i>
        </button>

        <!-- Donation Section -->
        <div id="donation-widget" class="absolute bottom-5 flex justify-center w-full pointer-events-none">
            <div class="bg-black/50 backdrop-blur-sm p-2 rounded-full flex items-center gap-2 border border-slate-700 shadow-lg pointer-events-auto">
                <i data-lucide="heart" class="text-red-500"></i>
                <span class="text-xs text-white">For Donations: </span>
                <p class="text-xs text-white font-mono hidden sm:block">DpkJ...RBYK</p>
                <button id="copy-donation-wallet" class="px-3 py-1 text-xs bg-slate-700 text-white rounded-full hover:bg-slate-600 transition">Copy</button>
            </div>
        </div>

    </div>
    
    <!-- OpenLayers Popup (for hover) -->
    <div id="popup" class="ol-popup"><div id="popup-content"></div></div>

    <!-- Pre-Graffiti Modal -->
    <div id="pre-graffiti-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-slate-900 rounded-lg shadow-xl p-8 w-full max-w-sm modal-fade-in border border-slate-800 text-center">
            <h2 class="text-2xl font-bold text-white mb-6">How do you want to place it?</h2>
            <div class="flex flex-col gap-4">
                <button id="pre-graffiti-tap" class="w-full py-3 px-4 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 transition transform hover:scale-105 flex items-center justify-center gap-2"><i data-lucide="map-pin"></i> Tap on Map</button>
                <button id="pre-graffiti-search" class="w-full py-3 px-4 bg-slate-700 text-white font-semibold rounded-md hover:bg-slate-600 transition transform hover:scale-105 flex items-center justify-center gap-2"><i data-lucide="search"></i> Search Address</button>
            </div>
             <button id="close-pre-graffiti-modal" class="text-slate-500 hover:text-white transition absolute top-4 right-4"><i data-lucide="x"></i></button>
        </div>
    </div>
    
    <!-- Add Graffiti Modal -->
    <div id="graffiti-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-slate-900 rounded-lg shadow-xl p-6 w-full max-w-md modal-fade-in border border-slate-800">
            <h2 class="text-2xl font-bold mb-4 text-white">Add Graffiti</h2>
            <form id="graffiti-form">
                <input type="hidden" id="latitude" name="latitude"><input type="hidden" id="longitude" name="longitude">
                <div class="mb-4">
                    <label for="graffiti-wallet" class="block text-sm font-medium text-slate-300">Payment Wallet for this Post</label>
                    <input type="text" id="graffiti-wallet" required class="mt-1 block w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 text-white font-mono text-sm">
                </div>
                <div class="mb-4">
                    <label for="address" class="block text-sm font-medium text-slate-300">Or search for an address</label>
                    <div class="flex"><input type="text" id="address" class="mt-1 block w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 text-white sm:text-sm"><button type="button" id="search-address" class="ml-2 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Search</button></div>
                </div>
                <div class="mb-4">
                    <label for="challenge-link" class="block text-sm font-medium text-slate-300">Link to Challenge (Optional)</label>
                    <select id="challenge-link" class="mt-1 block w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 text-white">
                        <option value="">None</option>
                        <!-- Challenges will be populated here -->
                    </select>
                </div>
                <div class="mb-4"><label for="description" class="block text-sm font-medium text-slate-300">Description</label><textarea id="description" rows="3" class="mt-1 block w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 text-white sm:text-sm" required></textarea></div>
                <div class="mb-4"><label for="color" class="block text-sm font-medium text-slate-300">Marker Color</label><input type="color" id="color" value="#4ade80" class="mt-1 block w-full h-10 border-slate-700 rounded-md bg-slate-800"></div>
                
                <div class="mb-4 space-y-4">
                    <div>
                        <label for="image-url" class="block text-sm font-medium text-slate-300">Image URL</label>
                        <input type="url" id="image-url" placeholder="https://example.com/image.jpg" class="mt-1 block w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-md text-white">
                    </div>
                     <div>
                        <label for="video-url" class="block text-sm font-medium text-slate-300">Video URL (YouTube, TikTok, Instagram)</label>
                        <input type="url" id="video-url" placeholder="https://www.youtube.com/watch?v=..." class="mt-1 block w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-md text-white">
                    </div>
                </div>

                <div class="flex justify-end space-x-2"><button type="button" id="cancel-graffiti" class="px-4 py-2 bg-slate-700 text-white rounded-md hover:bg-slate-600 transition">Cancel</button><button type="submit" id="submit-graffiti" class="px-4 py-2 bg-gradient-to-r from-green-500 to-teal-600 text-white font-semibold rounded-md hover:from-green-600 hover:to-teal-700 transition">Save</button></div>
            </form>
        </div>
    </div>
    
    <!-- "My Graffiti" Modal -->
    <div id="my-graffiti-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-slate-900 rounded-lg shadow-xl p-6 w-full max-w-lg modal-fade-in border border-slate-800 flex flex-col" style="height: 70vh;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white flex items-center gap-2"><i data-lucide="history"></i> My History</h2>
                <button id="close-my-graffiti-modal" class="text-slate-400 hover:text-white transition"><i data-lucide="x"></i></button>
            </div>
            <div id="my-graffiti-list" class="flex-grow overflow-y-auto pr-2"></div>
        </div>
    </div>

    <!-- Challenges Modal -->
    <div id="challenges-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-slate-900 rounded-lg shadow-xl p-6 w-full max-w-2xl modal-fade-in border border-slate-800 flex flex-col" style="height: 80vh;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white flex items-center gap-2"><i data-lucide="trophy"></i> Challenges</h2>
                <button id="close-challenges-modal" class="text-slate-400 hover:text-white transition"><i data-lucide="x"></i></button>
            </div>
            <div class="flex-grow overflow-y-auto pr-2 space-y-6 challenge-list-container">
                 <div>
                    <h3 class="text-lg font-bold text-green-400 border-b border-slate-700 pb-2 mb-3">Ongoing</h3>
                    <div id="ongoing-challenges-list" class="space-y-3"></div>
                 </div>
                 <div>
                    <h3 class="text-lg font-bold text-slate-400 border-b border-slate-700 pb-2 mb-3">Finished</h3>
                    <div id="finished-challenges-list" class="space-y-3"></div>
                 </div>
                 <div id="admin-challenge-info" class="hidden p-3 bg-slate-800/50 border border-slate-700 rounded-lg text-center text-sm text-slate-400">
                    <p><b class="text-green-400">Admin Tip:</b> Create and manage challenges directly in your Firebase 'challenges' collection.</p>
                 </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profile-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-slate-900 rounded-lg shadow-xl p-8 w-full max-w-md modal-fade-in border border-slate-800">
             <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white flex items-center gap-2"><i data-lucide="user-circle"></i> My Profile</h2>
                <button id="close-profile-modal" class="text-slate-400 hover:text-white transition"><i data-lucide="x"></i></button>
            </div>
            <div class="space-y-4">
                <div class="flex items-center gap-4">
                     <img id="profile-avatar" src="https://placehold.co/80x80/1e293b/4ade80?text=P" class="w-20 h-20 rounded-full border-4 border-slate-700 object-cover">
                     <div>
                        <p id="profile-username" class="text-xl font-semibold text-white"></p>
                     </div>
                </div>

                <div id="connect-x-container">
                    <button id="connect-x-btn" class="w-full py-2.5 px-4 bg-black text-white font-semibold rounded-md hover:bg-gray-800 transition flex items-center justify-center gap-2"><i data-lucide="twitter"></i> Connect with X</button>
                </div>
                 <div id="x-info-container" class="hidden">
                    <label class="text-sm font-medium text-slate-400">X Profile</label>
                    <a id="profile-x-link" href="#" target="_blank" class="flex items-center gap-2 text-sm text-cyan-400 hover:underline">
                        <span id="profile-x-username"></span>
                    </a>
                </div>

                 <div>
                    <label class="text-sm font-medium text-slate-400">Wallet Address</label>
                    <div id="wallet-display-container">
                        <p id="profile-wallet" class="text-sm font-mono text-slate-300 break-all bg-slate-800 p-2 rounded-md"></p>
                        <button id="edit-wallet-btn" class="text-xs text-green-400 hover:underline mt-1">Edit</button>
                    </div>
                    <div id="wallet-edit-container" class="hidden">
                        <input type="text" id="profile-wallet-input" class="text-sm font-mono block w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 text-white transition">
                        <button id="save-wallet-btn" class="text-xs bg-green-600 text-white px-2 py-1 rounded-md hover:bg-green-700 mt-2">Save</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Media Viewer Modal -->
    <div id="media-viewer-modal" class="fixed inset-0 bg-gray-900/50 backdrop-blur-lg flex items-center justify-center p-4 z-[60] hidden">
        <div class="bg-slate-800/80 rounded-lg shadow-xl w-full max-w-2xl modal-fade-in border border-slate-700 flex flex-col relative">
             <button id="close-media-viewer-modal" class="absolute -top-3 -right-3 text-slate-400 bg-slate-800 rounded-full p-1.5 border border-slate-700 hover:text-white transition z-10"><i data-lucide="x"></i></button>
             <div id="media-viewer-content" class="w-full bg-black rounded-t-lg"></div>
             <div class="p-6">
                <div class="flex justify-between items-start">
                    <div>
                        <h3 id="media-viewer-title" class="text-2xl font-bold text-white"></h3>
                        <p id="media-viewer-author" class="text-sm text-slate-400 mb-4"></p>
                    </div>
                    <div class="flex items-center gap-4">
                         <div id="media-viewer-reward" class="text-lg font-bold text-green-400 text-glow hidden"></div>
                         <a id="author-x-link" href="#" target="_blank" class="hidden items-center gap-2 px-3 py-1.5 bg-black text-white text-sm font-semibold rounded-md hover:bg-gray-800 transition">
                            <i data-lucide="twitter" class="w-4 h-4"></i>
                         </a>
                    </div>
                </div>
                <a id="media-viewer-source-link" href="#" target="_blank" class="mt-4 inline-flex items-center gap-2 px-4 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 transition hidden">
                    <i data-lucide="external-link"></i> View Source
                </a>
             </div>
        </div>
    </div>

    <!-- Chat Modal -->
    <div id="chat-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-[70] hidden">
        <div class="bg-slate-900 rounded-lg shadow-xl w-full max-w-lg modal-fade-in border border-slate-800 flex flex-col" style="height: 80vh;">
            <div class="flex justify-between items-center p-4 border-b border-slate-800">
                 <h2 class="text-2xl font-bold text-white flex items-center gap-2"><i data-lucide="message-square"></i> Global Chat</h2>
                <button id="close-chat-modal" class="text-slate-400 hover:text-white transition"><i data-lucide="x"></i></button>
            </div>
            <div class="p-4 border-b border-slate-800">
                <div class="flex bg-slate-800 rounded-md p-1">
                    <button id="chat-room-english" class="flex-1 py-1 text-sm rounded-md transition">English</button>
                    <button id="chat-room-espanol" class="flex-1 py-1 text-sm rounded-md transition">Español</button>
                </div>
            </div>
            <div id="chat-messages" class="flex-grow p-4 overflow-y-auto flex flex-col-reverse">
                <!-- Messages will be appended here -->
            </div>
            <div class="p-4 border-t border-slate-800 relative">
                 <emoji-picker class="absolute bottom-20 right-4" style="display: none;"></emoji-picker>
                <form id="chat-form" class="flex items-center gap-2">
                    <button type="button" id="emoji-btn" class="p-2 text-slate-400 hover:text-white transition"><i data-lucide="smile"></i></button>
                    <input type="text" id="chat-input" placeholder="Type a message..." required class="flex-1 px-3 py-2 bg-slate-800 border border-slate-700 rounded-full shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 text-white transition">
                    <button type="submit" class="p-3 bg-green-600 text-white rounded-full hover:bg-green-700 transition"><i data-lucide="send"></i></button>
                </form>
            </div>
        </div>
    </div>


    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, TwitterAuthProvider, linkWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, setDoc, doc, getDoc, serverTimestamp, orderBy, limit, updateDoc, increment, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBvk61LjapStYDRvUJY2duNbYZxvK6BCOk",
            authDomain: "carreras-pro.firebaseapp.com",
            projectId: "carreras-pro",
            storageBucket: "carreras-pro.appspot.com",
            messagingSenderId: "691582453913",
            appId: "1:691582453913:web:1e1a607c1aae110f325008",
            measurementId: "G-0LC4YDBWPL"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let userId, username, currentUserWallet;
        let map; 
        let isPlacingGraffiti = false;
        let userListener, challengesListener, chatListener, myGraffitiListener, publicGraffitiListener, userGraffitiListener = null;
        let currentChatRoom = 'english';
        let preselectedChallengeId = null;
        
        const authContainer = document.getElementById('auth-container');
        const userInfoHeader = document.getElementById('user-info');
        const guestInfoHeader = document.getElementById('guest-info');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');

        function showToast(message) {
            toastMessage.textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // --- AUTH STATE & DATA LISTENERS ---
        onAuthStateChanged(auth, async (user) => {
            [userListener, challengesListener, chatListener, myGraffitiListener, publicGraffitiListener, userGraffitiListener].forEach(l => l && l());

            if (user) {
                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);

                if (userDoc.exists() && userDoc.data().banned === true) {
                    alert("Your account has been suspended.");
                    signOut(auth);
                    return;
                }

                userId = user.uid;
                username = userDoc.exists() ? userDoc.data().username : user.email.split('@')[0];
                document.getElementById('username-display').textContent = username;

                userInfoHeader.classList.remove('hidden');
                userInfoHeader.classList.add('flex');
                guestInfoHeader.classList.add('hidden');
                
                if (!map) setupMap();
                else { listenToGraffitiData(map.getLayers().getArray()[1].getSource(), userId); }

                listenToUserData(user.uid);
                listenToMyGraffiti();
                listenToChallenges(); 
                listenToChat(currentChatRoom);
            } else {
                userId = null;
                username = null;
                currentUserWallet = null;
                
                userInfoHeader.classList.add('hidden');
                userInfoHeader.classList.remove('flex');
                guestInfoHeader.classList.remove('hidden');
                
                if (!map) setupMap();
                else { listenToGraffitiData(map.getLayers().getArray()[1].getSource(), null); }
                listenToChallenges(); 
            }
            lucide.createIcons();
        });
        
        document.getElementById('login-btn').addEventListener('click', () => authContainer.classList.remove('hidden'));
        document.getElementById('close-auth-modal').addEventListener('click', () => authContainer.classList.add('hidden'));

        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const usernameInput = document.getElementById('auth-username').value;
            const password = document.getElementById('auth-password').value;
            const walletAddress = document.getElementById('auth-wallet').value;
            const errorP = document.getElementById('auth-error');
            const authButton = document.getElementById('auth-button');

            if (!walletAddress || walletAddress.length < 32 || walletAddress.length > 44) {
                errorP.textContent = 'Please enter a valid Solana wallet address.'; return;
            }

            errorP.textContent = '';
            authButton.disabled = true;
            authButton.textContent = 'Processing...';

            const email = `${usernameInput.trim().toLowerCase()}@graffiti-map.com`;

            try {
                await signInWithEmailAndPassword(auth, email, password);
                authContainer.classList.add('hidden');
            } catch (loginError) {
                if (loginError.code === 'auth/invalid-credential' || loginError.code === 'auth/user-not-found') {
                    try {
                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        await setDoc(doc(db, "users", userCredential.user.uid), { 
                            username: usernameInput, walletAddress, banned: false, isAdmin: false
                        });
                        authContainer.classList.add('hidden');
                    } catch (registerError) {
                        errorP.textContent = registerError.code === 'auth/weak-password' ? 'Password must be at least 6 characters.' : 'Could not create account.';
                    }
                } else {
                    errorP.textContent = 'Incorrect username or password.';
                }
            } finally {
                authButton.disabled = false;
                authButton.textContent = 'Continue';
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
        
        // --- REALTIME LISTENERS ---
        function listenToUserData(uid) {
            const userDocRef = doc(db, "users", uid);
            userListener = onSnapshot(userDocRef, (doc) => {
                if (doc.exists()) {
                    const userData = doc.data();
                    currentUserWallet = userData.walletAddress;
                    document.getElementById('profile-username').textContent = userData.username;
                    document.getElementById('profile-wallet').textContent = userData.walletAddress;
                    document.getElementById('profile-wallet-input').value = userData.walletAddress;
                    
                    const userAvatar = document.getElementById('user-avatar');
                    const profileAvatar = document.getElementById('profile-avatar');
                    
                    if (userData.xProfileImageUrl) {
                        userAvatar.src = userData.xProfileImageUrl;
                        profileAvatar.src = userData.xProfileImageUrl;
                        document.getElementById('connect-x-container').classList.add('hidden');
                        document.getElementById('x-info-container').classList.remove('hidden');
                        document.getElementById('profile-x-username').textContent = `@${userData.xUsername}`;
                        document.getElementById('profile-x-link').href = `https://x.com/${userData.xUsername}`;
                    } else {
                        const initial = (userData.username || 'P').charAt(0).toUpperCase();
                        userAvatar.src = `https://placehold.co/32x32/1e293b/4ade80?text=${initial}`;
                        profileAvatar.src = `https://placehold.co/80x80/1e293b/4ade80?text=${initial}`;
                        document.getElementById('connect-x-container').classList.remove('hidden');
                        document.getElementById('x-info-container').classList.add('hidden');
                    }

                    if (userData.isAdmin) document.getElementById('admin-challenge-info').classList.remove('hidden');
                }
            });
        }
        
        function listenToChallenges() {
            if (challengesListener) challengesListener();
            challengesListener = onSnapshot(query(collection(db, "challenges")), (snapshot) => {
                const ongoingList = document.getElementById('ongoing-challenges-list');
                const finishedList = document.getElementById('finished-challenges-list');
                const challengeDropdown = document.getElementById('challenge-link');
                
                ongoingList.innerHTML = '';
                finishedList.innerHTML = '';
                challengeDropdown.innerHTML = '<option value="">None</option>';

                 if (snapshot.empty) {
                    ongoingList.innerHTML = `<p class="text-slate-400 text-center mt-4">No active challenges right now.</p>`;
                    return;
                }

                snapshot.forEach(doc => {
                    const challenge = doc.data();
                    challenge.id = doc.id; 
                    
                    let winnersHTML = '';
                    if (challenge.winners && Object.keys(challenge.winners).length > 0) {
                        winnersHTML = '<h4 class="text-sm font-bold text-slate-400 mt-3">Winners:</h4><ul class="list-disc list-inside text-sm text-slate-300">' +
                                      Object.values(challenge.winners).map(name => `<li>${name}</li>`).join('') + '</ul>';
                    }
                    
                    let participantsHTML = '';
                    if (challenge.participants && Object.keys(challenge.participants).length > 0) {
                        participantsHTML = '<h4 class="text-sm font-bold text-slate-400 mt-3">Participants:</h4><ul class="list-disc list-inside text-sm text-slate-300">' +
                                      Object.values(challenge.participants).map(name => `<li>${name}</li>`).join('') + '</ul>';
                    }
                    
                    const isFull = challenge.maxParticipants && (challenge.participantCount || 0) >= challenge.maxParticipants;
                    const buttonHTML = isFull ? 
                        `<button class="mt-3 w-full py-2 text-sm bg-slate-600 text-slate-400 rounded-md cursor-not-allowed" disabled>Full</button>` :
                        `<button data-challenge-id="${challenge.id}" class="participate-btn mt-3 w-full py-2 text-sm bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 transition">Participate</button>`;
                    
                    let infoLinksHTML = '';
                    const links = challenge.infoLinks || challenge.infolinks;
                    if (links && Array.isArray(links)) {
                        infoLinksHTML = links.map((link, index) => 
                            `<a href="${link}" target="_blank" class="text-xs text-cyan-400 hover:underline">More Info ${index + 1}</a>`
                        ).join(' | ');
                    }

                    const div = document.createElement('div');
                    div.className = 'p-4 bg-slate-800 rounded-lg';
                    div.innerHTML = `
                        <h3 class="font-bold text-green-400">${challenge.title}</h3>
                        <p class="text-sm text-slate-300 mt-1">${challenge.description}</p>
                        <div class="mt-1">${infoLinksHTML}</div>
                        <div class="flex justify-between items-center mt-2">
                           ${challenge.reward ? `<p class="text-xs text-green-400 font-bold">${challenge.reward} SOL Reward</p>` : '<div></div>'}
                           <p class="text-xs text-slate-400 flex items-center gap-1"><i data-lucide="users" class="w-3 h-3"></i>${challenge.participantCount || 0} ${challenge.maxParticipants ? `/ ${challenge.maxParticipants}` : 'Participants'}</p>
                        </div>
                        ${participantsHTML}
                        ${winnersHTML}
                        ${challenge.status === 'ongoing' ? buttonHTML : ''}
                    `;
                    
                    if(challenge.status === 'ongoing') {
                        ongoingList.appendChild(div);
                        if (!isFull) {
                            const option = document.createElement('option');
                            option.value = challenge.id;
                            option.textContent = challenge.title;
                            challengeDropdown.appendChild(option);
                        }
                    } else {
                        finishedList.appendChild(div);
                    }
                });
                lucide.createIcons();
            });
        }
        
        // --- MAP LOGIC ---
        const popupContainer = document.getElementById('popup');
        const popupContent = document.getElementById('popup-content');
        const overlay = new ol.Overlay({ element: popupContainer, autoPan: false });
        
        function generateEmbedHTML(videoUrl, isHover = false) {
            if (!videoUrl) return '';
            const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
            if (youtubeRegex.test(videoUrl)) {
                const videoId = videoUrl.match(youtubeRegex)[1];
                const params = isHover ? `?autoplay=1&mute=1&controls=0&showinfo=0&loop=1&playlist=${videoId}` : '?autoplay=1';
                return `<iframe src="https://www.youtube.com/embed/${videoId}${params}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" ${!isHover ? 'allowfullscreen' : ''} class="${isHover ? 'pointer-events-none' : ''}"></iframe>`;
            }
            const instagramRegex = /https:\/\/(?:www\.)?instagram\.com\/(?:p|reel)\/([a-zA-Z0-9_-]+)/;
            if (instagramRegex.test(videoUrl)) {
                 return `<iframe src="https://www.instagram.com/p/${videoUrl.match(instagramRegex)[1]}/embed" width="320" height="400" frameborder="0" scrolling="no" allowtransparency="true"></iframe>`;
            }
            const tiktokRegex = /https:\/\/(?:www\.)?tiktok\.com\/.*\/video\/(\d+)/;
            if (tiktokRegex.test(videoUrl)) {
                 return isHover ? '' : `<blockquote class="tiktok-embed" cite="${videoUrl}" data-video-id="${videoUrl.match(tiktokRegex)[1]}" style="max-width: 320px;min-width: 320px;" > <section> <a target="_blank" title="video" href="${videoUrl}">Watch on TikTok</a> </section> </blockquote> <script async src="https://www.tiktok.com/embed.js"><\/script>`;
            }
            return '';
        }

        const verifiedIconSrc = `data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%234ade80" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`;

        function setupMap() {
            const graffitiLayer = new ol.layer.Vector({
                source: new ol.source.Vector(),
                style: function(feature) {
                    const isApproved = feature.get('approved');
                    const baseStyle = new ol.style.Style({
                        image: new ol.style.Circle({
                            radius: 8,
                            fill: new ol.style.Fill({ color: isApproved ? (feature.get('color') || '#4ade80') : 'rgba(100, 116, 139, 0.5)' }),
                            stroke: new ol.style.Stroke({ color: isApproved ? 'rgba(255,255,255,0.8)' : 'rgba(156, 163, 175, 0.8)', width: 2 })
                        })
                    });

                    if (feature.get('verifiedWinner') === true) {
                        const verifiedStyle = new ol.style.Style({
                            image: new ol.style.Icon({
                                src: verifiedIconSrc,
                                anchor: [0.5, 0.5],
                                scale: 1.2,
                                offset: [10, -10] // Position top-right
                            })
                        });
                        return [baseStyle, verifiedStyle];
                    }
                    return baseStyle;
                }
            });

            map = new ol.Map({
                target: 'map',
                layers: [ new ol.layer.Tile({ source: new ol.source.XYZ({ url: 'https://{a-d}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', attributions: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>' }) }), graffitiLayer ],
                view: new ol.View({ center: ol.proj.fromLonLat([-74.006, 40.7128]), zoom: 3 }),
                overlays: [overlay], controls: []
            });
            
            listenToGraffitiData(graffitiLayer.getSource(), userId);

            let hoveredFeature = null;
            map.on('pointermove', (e) => {
                if (isPlacingGraffiti) { map.getTargetElement().style.cursor = 'crosshair'; return; }
                const feature = map.forEachFeatureAtPixel(e.pixel, f => f);
                map.getTargetElement().style.cursor = feature ? 'pointer' : '';
                if (feature !== hoveredFeature) {
                    overlay.setPosition(undefined);
                    if (feature && feature.get('approved')) {
                        const { description, videoUrl, imageUrl } = feature.getProperties();
                        let content = `<h4 class="font-bold text-base text-white truncate">${description}</h4>`;
                        if (videoUrl && (videoUrl.includes('youtube.com') || videoUrl.includes('youtu.be'))) {
                            content += generateEmbedHTML(videoUrl, true);
                        } else if (imageUrl) {
                            content += `<img src="${imageUrl}" alt="Graffiti Image">`;
                        }
                        popupContent.innerHTML = content;
                        overlay.setPosition(feature.getGeometry().getCoordinates());
                    }
                    hoveredFeature = feature;
                }
            });

            map.on('singleclick', async (evt) => {
                if (isPlacingGraffiti) {
                    const coords = ol.proj.toLonLat(evt.coordinate);
                    document.getElementById('latitude').value = coords[1];
                    document.getElementById('longitude').value = coords[0];
                    if(preselectedChallengeId) {
                        document.getElementById('challenge-link').value = preselectedChallengeId;
                        preselectedChallengeId = null; 
                    }
                    document.getElementById('graffiti-wallet').value = currentUserWallet;
                    document.getElementById('graffiti-modal').classList.remove('hidden');
                    document.getElementById('pre-graffiti-modal').classList.add('hidden');
                    isPlacingGraffiti = false;
                    map.getTargetElement().classList.remove('map-cursor-add');
                } else {
                    const feature = map.forEachFeatureAtPixel(evt.pixel, (f) => f);
                    if (feature) {
                        if (!feature.get('approved')) {
                            showToast('This graffiti is pending approval.');
                            return;
                        }

                        overlay.setPosition(undefined); hoveredFeature = null;
                        const { description, author, authorUsername, videoUrl, imageUrl, challengeReward } = feature.getProperties();
                        
                        document.getElementById('media-viewer-title').textContent = description;
                        document.getElementById('media-viewer-author').textContent = authorUsername ? `By: ${authorUsername}` : '';
                        const mediaContentEl = document.getElementById('media-viewer-content');
                        const sourceLinkEl = document.getElementById('media-viewer-source-link');
                        const authorXLink = document.getElementById('author-x-link');
                        const rewardEl = document.getElementById('media-viewer-reward');
                        
                        mediaContentEl.innerHTML = ''; 
                        sourceLinkEl.classList.add('hidden');
                        authorXLink.classList.add('hidden');
                        rewardEl.classList.add('hidden');

                        if (challengeReward) {
                            rewardEl.textContent = `${challengeReward} SOL`;
                            rewardEl.classList.remove('hidden');
                        }
                        
                        if (author) {
                            const authorDoc = await getDoc(doc(db, 'users', author));
                            if(authorDoc.exists() && authorDoc.data().xUsername) {
                                authorXLink.href = `https://x.com/${authorDoc.data().xUsername}`;
                                authorXLink.classList.remove('hidden');
                            }
                        }

                        let sourceUrl = videoUrl || imageUrl;
                        mediaContentEl.innerHTML = videoUrl ? generateEmbedHTML(videoUrl, false) : (imageUrl ? `<img src="${imageUrl}" alt="Graffiti Image">` : '');
                        
                        if(sourceUrl) {
                            sourceLinkEl.href = sourceUrl;
                            sourceLinkEl.classList.remove('hidden');
                        }
                        document.getElementById('media-viewer-modal').classList.remove('hidden');
                        lucide.createIcons();
                    }
                }
            });
        }
        
        function listenToGraffitiData(source, currentUserId) {
            if(publicGraffitiListener) publicGraffitiListener();
            if(userGraffitiListener) userGraffitiListener();
            source.clear();

            publicGraffitiListener = onSnapshot(query(collection(db, "graffiti"), where("approved", "==", true)), (snapshot) => {
                snapshot.docChanges().forEach(change => updateMapFeatures(change, source));
            });

            if (currentUserId) {
                userGraffitiListener = onSnapshot(query(collection(db, "graffiti"), where("author", "==", currentUserId), where("approved", "==", false)), (snapshot) => {
                    snapshot.docChanges().forEach(change => updateMapFeatures(change, source));
                });
            }
        }
        
        function updateMapFeatures(change, source) {
            const data = change.doc.data();
            const featureId = change.doc.id;
            const existingFeature = source.getFeatureById(featureId);

            if (change.type === "removed") {
                if (existingFeature) {
                    source.removeFeature(existingFeature);
                }
                return;
            }

            if (existingFeature) {
               source.removeFeature(existingFeature);
            }
            
            const newFeature = new ol.Feature({ geometry: new ol.geom.Point(ol.proj.fromLonLat(data.coordinates)), ...data });
            newFeature.setId(featureId);
            source.addFeature(newFeature);
        }

        // --- MODAL & FORM LOGIC ---
        const graffitiForm = document.getElementById('graffiti-form');
        const modals = ['graffiti-modal', 'my-graffiti-modal', 'challenges-modal', 'profile-modal', 'chat-modal', 'pre-graffiti-modal', 'media-viewer-modal'];
        modals.forEach(id => {
            const closeBtn = document.getElementById(`close-${id.replace('-modal', '')}-modal`);
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    document.getElementById(id).classList.add('hidden');
                    if(id === 'media-viewer-modal') document.getElementById('media-viewer-content').innerHTML = '';
                });
            }
        });
        
        document.getElementById('cancel-graffiti').addEventListener('click', () => {
            document.getElementById('graffiti-modal').classList.add('hidden');
            graffitiForm.reset();
        });

        document.querySelectorAll('[data-auth-required="true"]').forEach(elem => {
            elem.addEventListener('click', (e) => {
                if(!userId) {
                    e.stopPropagation();
                    authContainer.classList.remove('hidden');
                }
            });
        });

        document.getElementById('create-graffiti-btn').addEventListener('click', () => { if(userId) document.getElementById('pre-graffiti-modal').classList.remove('hidden') });
        document.getElementById('pre-graffiti-tap').addEventListener('click', () => {
            isPlacingGraffiti = true;
            map.getTargetElement().classList.add('map-cursor-add');
            document.getElementById('pre-graffiti-modal').classList.add('hidden');
        });
        document.getElementById('pre-graffiti-search').addEventListener('click', () => {
            document.getElementById('pre-graffiti-modal').classList.add('hidden');
            if(preselectedChallengeId) {
                document.getElementById('challenge-link').value = preselectedChallengeId;
                preselectedChallengeId = null; // Reset after use
            }
             document.getElementById('graffiti-wallet').value = currentUserWallet;
            document.getElementById('graffiti-modal').classList.remove('hidden');
        });
        
        document.getElementById('my-graffiti-btn').addEventListener('click', () => { if(userId) document.getElementById('my-graffiti-modal').classList.remove('hidden') });
        document.getElementById('challenges-btn').addEventListener('click', () => document.getElementById('challenges-modal').classList.remove('hidden'));
        document.getElementById('profile-btn').addEventListener('click', () => { if(userId) document.getElementById('profile-modal').classList.remove('hidden') });
        document.getElementById('chat-btn').addEventListener('click', () => { if(userId) document.getElementById('chat-modal').classList.remove('hidden') });

        document.getElementById('ongoing-challenges-list').addEventListener('click', (e) => {
            const participateBtn = e.target.closest('.participate-btn');
            if (participateBtn) {
                if (!userId) {
                    document.getElementById('challenges-modal').classList.add('hidden');
                    authContainer.classList.remove('hidden');
                    return;
                }
                preselectedChallengeId = participateBtn.dataset.challengeId;
                document.getElementById('challenges-modal').classList.add('hidden');
                document.getElementById('pre-graffiti-modal').classList.remove('hidden');
            }
        });

        graffitiForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('submit-graffiti');
            submitBtn.disabled = true; submitBtn.textContent = 'Saving...';
            
            const linkedChallengeId = document.getElementById('challenge-link').value;
            const paymentWallet = document.getElementById('graffiti-wallet').value;

            if (!paymentWallet || paymentWallet.length < 32 || paymentWallet.length > 44) {
                 alert('Please enter a valid Solana wallet for this post.');
                 submitBtn.disabled = false; submitBtn.textContent = 'Save';
                 return;
            }

            try {
                let challengeReward = null;
                const newGraffitiData = {
                    coordinates: [parseFloat(document.getElementById('longitude').value), parseFloat(document.getElementById('latitude').value)],
                    description: document.getElementById('description').value,
                    color: document.getElementById('color').value,
                    imageUrl: document.getElementById('image-url').value || null,
                    videoUrl: document.getElementById('video-url').value || null,
                    author: userId, authorUsername: username, createdAt: serverTimestamp(),
                    verifiedWinner: false,
                    approved: false, 
                    linkedChallengeId: linkedChallengeId || null,
                    paymentWallet: paymentWallet
                };
                
                if (linkedChallengeId) {
                    const challengeRef = doc(db, "challenges", linkedChallengeId);
                    await runTransaction(db, async (transaction) => {
                        const challengeDoc = await transaction.get(challengeRef);
                        if (!challengeDoc.exists()) throw "Challenge does not exist!";
                        
                        challengeReward = challengeDoc.data().reward || null;
                        newGraffitiData.challengeReward = challengeReward;

                        const newParticipants = { ...challengeDoc.data().participants, [userId]: username };
                        transaction.update(challengeRef, { 
                            participantCount: increment(1),
                            participants: newParticipants
                        });
                        
                        const graffitiRef = doc(collection(db, "graffiti"));
                        transaction.set(graffitiRef, newGraffitiData);
                    });
                } else {
                     await addDoc(collection(db, `graffiti`), newGraffitiData);
                }

                document.getElementById('graffiti-modal').classList.add('hidden');
                graffitiForm.reset();
                showToast('Graffiti submitted for approval!');

            } catch (error) {
                console.error("Error saving graffiti:", error);
                alert("Could not save graffiti. Please try again.");
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save';
            }
        });

        document.getElementById('search-address').addEventListener('click', async () => {
            const address = document.getElementById('address').value; if(!address) return;
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
            const data = await response.json();
            if(data && data.length > 0) {
                const [lon, lat] = [parseFloat(data[0].lon), parseFloat(data[0].lat)];
                document.getElementById('latitude').value = lat; document.getElementById('longitude').value = lon;
                map.getView().animate({ center: ol.proj.fromLonLat([lon, lat]), zoom: 15, duration: 1000 });
            } else { alert('Address not found.'); }
        });
        
        // Profile Wallet & X Connect Logic
        const walletDisplay = document.getElementById('wallet-display-container');
        const walletEdit = document.getElementById('wallet-edit-container');
        document.getElementById('edit-wallet-btn').addEventListener('click', () => { walletDisplay.classList.add('hidden'); walletEdit.classList.remove('hidden'); });
        document.getElementById('save-wallet-btn').addEventListener('click', async () => {
            const newWallet = document.getElementById('profile-wallet-input').value;
            if (newWallet && newWallet.length >= 32 && newWallet.length <= 44) {
                await updateDoc(doc(db, "users", userId), { walletAddress: newWallet });
                walletDisplay.classList.remove('hidden');
                walletEdit.classList.add('hidden');
            } else {
                alert('Please enter a valid Solana wallet address.');
            }
        });
        
        document.getElementById('connect-x-btn').addEventListener('click', async () => {
            if (!auth.currentUser) return;
            const provider = new TwitterAuthProvider();
            try {
                const result = await linkWithPopup(auth.currentUser, provider);
                const credential = TwitterAuthProvider.credentialFromResult(result);
                const user = result.user;
                
                const xUsername = credential.screenName;
                const xProfileImageUrl = user.photoURL.replace('_normal', '_400x400');

                await updateDoc(doc(db, "users", userId), { xUsername, xProfileImageUrl });
                showToast('X account connected!');

            } catch (error) {
                console.error("X connection error:", error);
                if (error.code === 'auth/credential-already-in-use') {
                    alert('This X account is already linked to another user.');
                } else {
                    showToast('Failed to connect X account.');
                }
            }
        });


        function listenToMyGraffiti() {
            if (!userId) return;
            if (myGraffitiListener) myGraffitiListener();
            const graffitiList = document.getElementById('my-graffiti-list');
            const q = query(collection(db, "graffiti"), where("author", "==", userId));
            myGraffitiListener = onSnapshot(q, (snapshot) => {
                graffitiList.innerHTML = snapshot.empty ? `<p class="text-slate-400 text-center mt-4">You haven't created any graffiti yet.</p>` : '';
                
                const docs = snapshot.docs.sort((a,b) => (b.data().createdAt?.toMillis() || 0) - (a.data().createdAt?.toMillis() || 0));

                docs.forEach(docSnap => {
                    const graffiti = docSnap.data();
                    const status = graffiti.approved ? 
                        `<span class="text-xs font-bold text-green-400">Approved</span>` : 
                        `<span class="text-xs font-bold text-yellow-400">Pending Approval</span>`;

                    const div = document.createElement('div');
                    div.className = 'p-3 bg-slate-800 rounded-lg mb-2 flex justify-between items-center transition hover:bg-slate-700';
                    div.innerHTML = `
                        <div>
                            <p class="text-white truncate pr-4">${graffiti.description}</p>
                            ${status}
                        </div>
                        <button class="text-sm bg-green-600 px-3 py-1 rounded-md hover:bg-green-500 transition flex-shrink-0">View</button>
                    `;
                    div.querySelector('button').addEventListener('click', () => {
                        document.getElementById('my-graffiti-modal').classList.add('hidden');
                        map.getView().animate({ center: ol.proj.fromLonLat(graffiti.coordinates), zoom: 17, duration: 1000 });
                    });
                    graffitiList.appendChild(div);
                });
            });
        }
        
        // --- CHAT LOGIC ---
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.getElementById('chat-messages');
        const emojiBtn = document.getElementById('emoji-btn');
        const emojiPicker = document.querySelector('emoji-picker');
        const roomEnglishBtn = document.getElementById('chat-room-english');
        const roomEspanolBtn = document.getElementById('chat-room-espanol');
        
        function updateChatRoomUI() {
            if(currentChatRoom === 'english') {
                roomEnglishBtn.classList.add('bg-green-600', 'text-white');
                roomEspanolBtn.classList.remove('bg-green-600', 'text-white');
            } else {
                roomEspanolBtn.classList.add('bg-green-600', 'text-white');
                roomEnglishBtn.classList.remove('bg-green-600', 'text-white');
            }
        }
        updateChatRoomUI();

        roomEnglishBtn.addEventListener('click', () => { currentChatRoom = 'english'; updateChatRoomUI(); listenToChat(currentChatRoom); });
        roomEspanolBtn.addEventListener('click', () => { currentChatRoom = 'espanol'; updateChatRoomUI(); listenToChat(currentChatRoom); });
        
        emojiBtn.addEventListener('click', () => emojiPicker.style.display = emojiPicker.style.display === 'none' ? 'block' : 'none');
        emojiPicker.addEventListener('emoji-click', event => {
            chatInput.value += event.detail.unicode;
            emojiPicker.style.display = 'none';
        });

        function listenToChat(room) {
            if (chatListener) chatListener();
            const q = query(collection(db, 'chat', room, 'messages'), orderBy('timestamp', 'desc'), limit(50));
            chatListener = onSnapshot(q, (snapshot) => {
                chatMessages.innerHTML = '';
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const div = document.createElement('div');
                    div.className = `mb-3 max-w-xs ${msg.authorId === userId ? 'self-end' : 'self-start'}`;
                    const time = msg.timestamp?.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) || '';
                    div.innerHTML = `
                      <div class="p-3 rounded-lg ${msg.authorId === userId ? 'bg-green-600 text-white' : 'bg-slate-700'}">
                        ${msg.authorId !== userId ? `<p class="text-xs font-bold text-green-400">${msg.authorName}</p>` : ''}
                        <p class="text-white break-words">${msg.text}</p>
                        <p class="text-xs text-right mt-1 ${msg.authorId === userId ? 'text-green-200' : 'text-slate-400'}">${time}</p>
                      </div>
                    `;
                    chatMessages.appendChild(div);
                });
            });
        }
        
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = chatInput.value.trim();
            if(text) {
                chatInput.value = '';
                await addDoc(collection(db, 'chat', currentChatRoom, 'messages'), {
                    text, authorId: userId, authorName: username, timestamp: serverTimestamp()
                });
            }
        });
        
        // Donation Logic
        document.getElementById('copy-donation-wallet').addEventListener('click', () => {
            const wallet = 'DpkJp4NrauKiyhLu3MCNZCp7komfKgCaS7P1u5pnRBYK';
            navigator.clipboard.writeText(wallet).then(() => {
                showToast('Donation wallet copied!');
            }).catch(err => {
                console.error('Failed to copy wallet address:', err);
                showToast('Failed to copy.');
            });
        });

    </script>
</body>
</html>

